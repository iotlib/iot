/*!
 * Start Bootstrap - SB Admin v4.0.0-beta (https://startbootstrap.com/template-overviews/sb-admin)
 * Copyright 2013-2017 Start Bootstrap
 * Licensed under MIT (https://github.com/BlackrockDigital/startbootstrap-sb-admin/blob/master/LICENSE)
 */
!function(n){"use strict";function e(e,i,o,t,a){n.ajax({url:"/api"+i,method:e,success:t,error:a,data:o,dataType:"json"})}function i(e){n.post("/api/exec",JSON.stringify(e),function(n){console.log("api cmd response:",n)},"json")}function o(){a(),t()}function t(){var e=n(".template-collapsecard").html();n(e.formatUnicorn({id:"account-card",title:v.user.name,subtitle:v.user.email})).appendTo(".page-section-account")}function a(){var e=n(".page-section-devices");e.empty();var i=n(".template-devicecard").html();v.devices.forEach(function(o){console.log("device:",o);var t=o.lastseen-(new Date).getTime()<60,a=n(i.formatUnicorn({title:o.name,deviceid:o.id.substr(0,7),online:t?"online":offline,id:"device-"+o.id}));e.append(a),a.find(".btn-add-function").on("click",function(n){l(o.id)})}),null!==v.functions&&v.functions.forEach(function(n){c(n)})}function c(e){var i="device-"+e.deviceid,o=n("#"+i);try{d(e).appendTo(o.find("ul"))}catch(n){console.log("No such device:",i,n)}}function l(i,o,t){function a(){d.slideUp(d.remove)}var l=n(".template-functionline").html(),d=n(l);d.find(".btn-cancel").click(function(){a()}),void 0!==t&&(console.log("editing"),d.find(".function-name").val(t.name||""),d.find(".function-pin").val(t.pin||""),d.find(".function-dw-invert").prop("checked",t.data.invert||!1),d.find(".btn-cancel").click(function(){c(t)})),d.find(".btn-save").click(function(){console.log("saving...");var n={name:d.find(".function-name").val(),pin:parseInt(d.find(".function-pin").val()),cmd:"DW",deviceid:i,data:{uielement:d.find(".function-dw-type").val(),invert:d.find(".function-dw-invert").is(":checked")}};console.log("func:",n),e("POST","/function",JSON.stringify(n),function(e){n.id=e.id},function(n){}),void 0!==o&&o(),c(n),a()});var s=n("#device-"+i);return d.hide().appendTo(s.find("ul")).slideDown(),d}function d(o){function t(){c.slideUp(c.remove)}var a=n(".template-switchfunction").html(),c=n(a.formatUnicorn({name:o.name}));return c.find("input").change(function(n){console.log("Clicked",this.checked),i({id:o.deviceid,cmd:"DW {pin} {val}".formatUnicorn({pin:o.pin,val:this.checked^o.data.invert?"HIGH":"LOW"})})}),c.find(".btn-remove").click(function(n){t(),console.log(o),e("DELETE","/function/"+o.id,null,function(){console.log("deleted function",o.id)})}),c.find(".btn-edit").click(function(n){t(),console.log(o),l(o.deviceid,function(){e("DELETE","/function/"+o.id,null,function(){console.log("deleted function",o.id)})},o)}),c}function s(){n("#navbarResponsive").collapse("hide"),n(".tooltip.navbar-sidenav-tooltip.fade.bs-tooltip-right.show").hide()}function r(e){n(".page-section").hide();n(".page-section-"+e).show();var i=n("li[data-nav-target="+e+"]").text();n(".navbar-brand").text(i),s()}var v={};r("devices"),n.getJSON("/api/profile",function(n){console.log("Json resp:",n),v=n,console.log(JSON.stringify(n," "," ")),o()}),window.api=e,n("#nav-signout").click(function(n){s()}),n("li[data-nav-target]").click(function(e){e.preventDefault(),r(n(this).attr("data-nav-target"))}),n('.navbar-sidenav [data-toggle="tooltip"]').tooltip({template:'<div class="tooltip navbar-sidenav-tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner"></div></div>'}),n("#sidenavToggler").click(function(e){e.preventDefault(),n("body").toggleClass("sidenav-toggled"),n(".navbar-sidenav .nav-link-collapse").addClass("collapsed"),n(".navbar-sidenav .sidenav-second-level, .navbar-sidenav .sidenav-third-level").removeClass("show")}),n(".navbar-sidenav .nav-link-collapse").click(function(e){e.preventDefault(),n("body").removeClass("sidenav-toggled")}),n("body.fixed-nav .navbar-sidenav, body.fixed-nav .sidenav-toggler, body.fixed-nav .navbar-collapse").on("mousewheel DOMMouseScroll",function(n){var e=n.originalEvent,i=e.wheelDelta||-e.detail;this.scrollTop+=30*(i<0?1:-1),n.preventDefault()}),n(document).scroll(function(){n(this).scrollTop()>100?n(".scroll-to-top").fadeIn():n(".scroll-to-top").fadeOut()}),n('[data-toggle="tooltip"]').tooltip(),n(document).on("click","a.scroll-to-top",function(e){var i=n(this);n("html, body").stop().animate({scrollTop:n(i.attr("href")).offset().top},1e3,"easeInOutExpo"),e.preventDefault()})}(jQuery);